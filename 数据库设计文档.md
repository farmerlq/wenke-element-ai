# AI聊天系统数据库设计文档

## 项目概述

基于前端接口需求，设计支持Dify、Coze、n8n三种AI平台的统一聊天系统数据库。

## 数据库配置

- **主机**: localhost:3306
- **账号**: root
- **密码**: yjakgl11
- **数据库名称**: ai_chat
- **字符集**: utf8mb4_unicode_ci

## 数据库结构

### 1. 系统管理表

#### 1.1 用户表 (sys_user)
存储系统用户信息，支持管理员和普通用户。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| user_id | BIGINT | 主键，自增 |
| user_name | VARCHAR(30) | 用户名，唯一 |
| nick_name | VARCHAR(30) | 用户昵称 |
| password | VARCHAR(100) | 密码（加密存储） |
| email | VARCHAR(50) | 邮箱，唯一 |
| phonenumber | VARCHAR(11) | 手机号码 |
| sex | CHAR(1) | 性别（0男 1女 2未知） |
| avatar | VARCHAR(100) | 头像地址 |
| status | CHAR(1) | 帐号状态（0正常 1停用） |
| del_flag | CHAR(1) | 删除标志（0存在 2删除） |
| login_ip | VARCHAR(50) | 最后登录IP |
| login_date | DATETIME | 最后登录时间 |
| create_by | VARCHAR(64) | 创建者 |
| create_time | DATETIME | 创建时间 |
| update_by | VARCHAR(64) | 更新者 |
| update_time | DATETIME | 更新时间 |
| remark | VARCHAR(500) | 备注 |

#### 1.2 角色表 (sys_role)
系统角色权限管理。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| role_id | BIGINT | 主键，自增 |
| role_name | VARCHAR(30) | 角色名称 |
| role_key | VARCHAR(100) | 角色权限字符串 |
| role_sort | INT | 显示顺序 |
| data_scope | CHAR(1) | 数据范围 |
| status | CHAR(1) | 角色状态 |
| del_flag | CHAR(1) | 删除标志 |

#### 1.3 用户角色关联表 (sys_user_role)
用户与角色的多对多关系。

### 2. AI平台配置表

#### 2.1 平台类型表 (ai_platform_type)
定义支持的AI平台类型。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| platform_type | VARCHAR(20) | 主键，平台类型标识 |
| platform_name | VARCHAR(50) | 平台名称 |
| description | TEXT | 平台描述 |

**平台类型数据**:
- dify: Dify AI应用开发平台
- coze: Coze AI Bot开发平台
- n8n: n8n工作流自动化平台

#### 2.2 AI智能体配置表 (ai_agent_config)
存储各平台的智能体/工作流配置。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| agent_id | BIGINT | 主键，自增 |
| agent_name | VARCHAR(100) | 智能体名称 |
| platform_type | VARCHAR(20) | 平台类型 |
| agent_key | VARCHAR(100) | 平台中的智能体标识 |
| description | TEXT | 智能体描述 |
| base_url | VARCHAR(255) | API基础URL |
| api_key | VARCHAR(255) | API密钥 |
| access_token | VARCHAR(255) | 访问令牌（Coze专用） |
| bot_id | VARCHAR(100) | Bot ID（Coze专用） |
| webhook_url | VARCHAR(255) | Webhook URL（n8n专用） |
| is_active | BOOLEAN | 是否激活 |
| is_default | BOOLEAN | 是否为默认配置 |
| is_stream | BOOLEAN | 是否启用流式响应 |
| user_id | BIGINT | 创建用户ID |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 3. 聊天核心表

#### 3.1 聊天会话表 (chat_session)
存储用户聊天会话。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| session_id | CHAR(36) | 主键，UUID4格式 |
| session_name | VARCHAR(200) | 会话名称 |
| user_id | BIGINT | 用户ID |
| agent_id | BIGINT | 使用的AI智能体配置ID |
| model | VARCHAR(100) | 使用的模型名称 |
| is_pinned | BOOLEAN | 是否置顶 |
| is_deleted | BOOLEAN | 是否删除 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### 3.2 聊天消息表 (chat_message)
存储聊天消息记录。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| message_id | BIGINT | 主键，自增 |
| session_id | CHAR(36) | 会话ID，UUID4格式 |
| user_id | BIGINT | 用户ID |
| agent_id | BIGINT | 使用的AI智能体配置ID |
| role | VARCHAR(20) | 消息角色（user/assistant/system） |
| content | TEXT | 消息内容 |
| content_type | VARCHAR(50) | 内容类型（text/image/file） |
| file_name | VARCHAR(255) | 文件名 |
| file_url | VARCHAR(500) | 文件URL |
| file_size | BIGINT | 文件大小（字节） |
| file_type | VARCHAR(100) | 文件类型 |
| model | VARCHAR(100) | 使用的模型 |
| tokens | INT | 消耗的token数 |
| parent_message_id | BIGINT | 父消息ID |
| is_deleted | BOOLEAN | 是否删除 |
| created_at | DATETIME | 创建时间 |

### 4. 系统配置表

#### 4.1 系统配置表 (sys_config)
存储系统配置参数。

#### 4.2 操作日志表 (sys_oper_log)
记录用户操作日志。

#### 4.3 文件存储表 (sys_file)
文件上传管理。

#### 4.4 聊天统计表 (chat_statistics)
用户聊天数据统计。

### 5. 视图设计

#### 5.1 用户会话列表视图 (v_user_chat_sessions)
提供会话列表的完整信息，包括消息统计。

#### 5.2 消息详情视图 (v_chat_messages)
提供消息详情的完整信息，关联用户、会话、智能体信息。

## 数据关系图

```
sys_user (用户)
    ├── chat_session (会话)
    │   └── chat_message (消息)
    ├── ai_agent_config (智能体配置)
    │   └── ai_platform_type (平台类型)
    ├── sys_user_role (用户角色)
    └── sys_role (角色)
```

## 默认数据

### 管理员账户
- 用户名: admin
- 密码: admin123（已加密存储）
- 邮箱: admin@ai.com

### AI平台配置
1. **Dify默认助手**
   - 平台: dify
   - API URL: https://api.dify.dev/v1
   - 状态: 默认激活

2. **Coze默认助手**
   - 平台: coze
   - API URL: https://api.coze.cn/open_api/v2
   - 状态: 激活

3. **n8n工作流**
   - 平台: n8n
   - Webhook URL: https://your-n8n-instance.com/webhook
   - 状态: 激活

## 使用指南

### 1. 连接数据库
```bash
mysql -h localhost -P 3306 -u root -p
# 密码: yjakgl11
USE ai_chat;
```

### 系统配置
```bash
# Dify平台配置
VITE_AI_PLATFORM=dify
VITE_DIFY_API_KEY=your-dify-api-key
VITE_DIFY_API_URL=https://api.dify.dev/v1
VITE_AI_STREAM=true

# Coze平台配置
VITE_AI_PLATFORM=coze
VITE_COZE_ACCESS_TOKEN=your-coze-access-token
VITE_COZE_BOT_ID=your-coze-bot-id
VITE_AI_STREAM=true

# n8n平台配置
VITE_AI_PLATFORM=n8n
VITE_N8N_WEBHOOK_URL=https://your-n8n-instance.com/webhook/chat
VITE_AI_STREAM=true

# 流式响应控制
VITE_AI_STREAM=false  # 禁用流式响应，使用阻塞模式
```

### 2. 配置智能体
```sql
-- 添加新的Dify智能体
INSERT INTO ai_agent_config (agent_name, platform_type, agent_key, description, base_url, api_key, user_id)
VALUES ('我的Dify助手', 'dify', 'my-app-key', '自定义Dify智能体', 'https://api.dify.dev/v1', 'your-actual-api-key', 1);

-- 添加新的Coze智能体
INSERT INTO ai_agent_config (agent_name, platform_type, agent_key, description, base_url, api_key, bot_id, user_id)
VALUES ('我的Coze机器人', 'coze', 'my-bot', '自定义Coze机器人', 'https://api.coze.cn/open_api/v2', 'your-access-token', 'your-bot-id', 1);

-- 添加新的n8n工作流
INSERT INTO ai_agent_config (agent_name, platform_type, agent_key, description, base_url, webhook_url, user_id)
VALUES ('我的n8n工作流', 'n8n', 'my-workflow', '自定义n8n工作流', 'https://your-n8n.com/webhook', 'https://your-n8n.com/webhook/chat', 1);
```

### 3. 查询数据
```sql
-- 查看用户会话列表
SELECT * FROM v_user_chat_sessions WHERE user_id = 1;

-- 查看会话消息详情
SELECT * FROM v_chat_messages WHERE session_id = 1 ORDER BY created_at ASC;

-- 查看智能体配置
SELECT * FROM ai_agent_config WHERE is_active = TRUE;
```

## 扩展说明

### 新增平台支持
如需支持新的AI平台：
1. 向 `ai_platform_type` 表插入新平台类型
2. 在 `ai_agent_config` 表中添加对应平台的配置记录
3. 前端适配器中添加新平台的API调用逻辑

### 性能优化
- 已为常用查询字段添加索引
- 视图优化了复杂查询的性能
- 支持按用户、时间、平台等多维度查询

## 备份建议
```bash
# 数据库备份命令
mysqldump -u root -p ai_chat > ai_chat_backup.sql
```