# 前端接口文档

## 项目概述
本项目是一个基于Vue3 + TypeScript的AI对话系统前端，采用模块化API设计，支持用户认证、会话管理、AI对话、模型管理等功能。

## 技术栈
- **前端框架**: Vue 3 + TypeScript
- **HTTP客户端**: hook-fetch (基于Fetch API的封装)
- **状态管理**: Pinia
- **UI组件库**: Element Plus + vue-element-plus-x
- **构建工具**: Vite

## 基础配置

### 环境变量
- `VITE_API_URL`: API基础URL，通过环境变量配置

### 请求配置
- **基础URL**: 从环境变量`VITE_API_URL`获取
- **请求头**:
  - `Content-Type: application/json`
  - `Authorization: Bearer ${token}` (JWT认证)
- **响应格式**: 统一返回格式
```typescript
interface BaseResponse {
  code: number; // 状态码
  data: T; // 响应数据
  msg: string; // 消息提示
  rows: T[]; // 列表数据
}
```

### 错误处理
- **401 Unauthorized**: 自动登出并弹出登录对话框
- **403 Forbidden**: 跳转到403页面
- **其他错误**: 显示错误消息提示

## 接口模块

### 1. 认证模块 (Auth API)

#### 1.1 用户登录
- **接口地址**: `POST /auth/login`
- **请求类型**: `LoginDTO`
- **响应类型**: `LoginVO`
- **描述**: 用户登录认证，获取访问令牌

```typescript
// 请求参数
interface LoginDTO {
  username: string; // 用户名
  password: string; // 密码
  code?: string; // 验证码
  confirmPassword?: string; // 二次确认密码
}

// 响应数据
interface LoginVO {
  access_token?: string; // 访问令牌
  token?: string; // 令牌
  userInfo?: LoginUser; // 用户信息
}

// 用户信息
interface LoginUser {
  avatar?: string; // 微信头像
  browser?: string; // 浏览器类型
  deptId?: number; // 部门ID
  deptName?: string; // 部门名
  expireTime?: number; // 过期时间
  ipaddr?: string; // 登录IP地址
  loginId?: string; // 登录id
  loginLocation?: string; // 登录地点
  loginTime?: number; // 登录时间
  menuPermission?: string[]; // 菜单权限
  nickName?: string; // 用户名
  os?: string; // 操作系统
  roleId?: number; // 角色ID
  rolePermission?: string[]; // 角色权限
  roles?: RoleDTO[]; // 角色对象
  tenantId?: string; // 租户ID
  token?: string; // 用户唯一标识
  userId?: number; // 用户ID
  username?: string; // 用户名
  userType?: string; // 用户类型
}

// 角色信息
interface RoleDTO {
  dataScope?: string; // 数据范围
  roleId?: number; // 角色ID
  roleKey?: string; // 角色权限
  roleName?: string; // 角色名称
}
```

#### 1.2 邮箱验证码
- **接口地址**: `POST /resource/email/code`
- **请求类型**: `EmailCodeDTO`
- **描述**: 发送邮箱验证码

```typescript
interface EmailCodeDTO {
  username?: string; // 邮箱地址
}
```

#### 1.3 用户注册
- **接口地址**: `POST /auth/register`
- **请求类型**: `RegisterDTO`
- **描述**: 用户注册账号

```typescript
interface RegisterDTO {
  username: string; // 邮箱
  password: string; // 密码
  code: string; // 验证码
  confirmPassword?: string; // 确认密码
}
```

### 2. 对话模块 (Chat API)

#### 2.1 发送消息
- **接口地址**: `POST /chat/send`
- **请求类型**: `SendDTO`
- **响应类型**: SSE流式响应
- **描述**: 发送AI对话消息，支持流式响应

```typescript
interface SendDTO {
  appId?: string; // 应用ID
  contentNumber?: number; // 上下文的条数
  isMcp?: boolean; // 是否开启mcp
  kid?: string; // 知识库id
  messages: Message[]; // 消息列表
  model?: string; // 模型名称
  prompt?: string; // 提示词
  search?: boolean; // 是否开启联网搜索(0关闭 1开启)
  sessionId?: string; // 会话id
  stream?: boolean; // 是否开启流式对话
  sysPrompt?: string; // 系统提示词
  userId?: number; // 用户id
  usingContext?: boolean; // 是否携带上下文
}

interface Message {
  content?: string; // 消息内容
  name?: string; // 名称
  reasoning_content?: string; // 推理内容
  role?: 'system' | 'user' | 'assistant' | 'function' | 'tool'; // 角色
  tool_call_id?: string; // 工具调用id
  tool_calls?: ToolCalls[]; // 工具调用列表
}

interface ToolCalls {
  function?: ToolCallFunction; // 函数调用
  id?: string; // 工具调用id
  type?: string; // 工具类型
}

interface ToolCallFunction {
  arguments?: string; // 方法参数
  name?: string; // 方法名
}
```

#### 2.2 获取聊天记录
- **接口地址**: `GET /system/message/list`
- **请求类型**: `GetChatListParams`
- **响应类型**: `ChatMessageVo[]`
- **描述**: 获取指定会话的聊天记录

```typescript
interface GetChatListParams {
  content?: string; // 消息内容
  createBy?: number; // 创建者
  createDept?: number; // 创建部门
  createTime?: Date; // 创建时间
  deductCost?: number; // 扣除金额
  id?: number; // 主键
  isAsc?: string; // 排序方向
  modelName?: string; // 模型名称
  orderByColumn?: string; // 排序列
  pageNum?: number; // 当前页数
  pageSize?: number; // 分页大小
  params?: object; // 请求参数
  remark?: string; // 备注
  role?: string; // 对话角色
  sessionId?: string; // 会话id
  totalTokens?: number; // 累计Tokens
  updateBy?: number; // 更新者
  updateTime?: Date; // 更新时间
  userId?: number; // 用户id
}

interface ChatMessageVo {
  content?: string; // 消息内容
  deductCost?: number; // 扣除金额
  id?: number; // 主键
  modelName?: string; // 模型名称
  remark?: string; // 备注
  role?: string; // 对话角色
  sessionId?: number; // 会话id
  totalTokens?: number; // 累计Tokens
  userId?: number; // 用户id
}
```

#### 2.3 添加聊天记录
- **接口地址**: `POST /system/message`
- **请求类型**: `ChatMessageVo`
- **描述**: 新增对应会话的聊天记录

### 3. 会话模块 (Session API)

#### 3.1 获取会话列表
- **接口地址**: `GET /system/session/list`
- **请求类型**: `GetSessionListParams`
- **响应类型**: `ChatSessionVo[]`
- **描述**: 获取用户的会话列表，支持分页

```typescript
interface GetSessionListParams {
  createBy?: number; // 创建者
  createDept?: number; // 创建部门
  createTime?: Date; // 创建时间
  id?: number; // 主键
  isAsc?: string; // 排序方向
  orderByColumn?: string; // 排序列
  pageNum?: number; // 当前页数
  pageSize?: number; // 分页大小
  params?: object; // 请求参数
  remark?: string; // 备注
  sessionContent?: string; // 会话内容
  sessionTitle?: string; // 会话标题
  updateBy?: number; // 更新者
  updateTime?: Date; // 更新时间
  userId: number; // 用户id（必填）
}

interface ChatSessionVo {
  id?: string; // 主键（字符串类型）
  remark?: string; // 备注
  sessionContent?: string; // 会话内容
  sessionTitle?: string; // 会话标题
  userId?: number; // 用户id
  createTime?: Date; // 创建时间
  prefixIcon?: Component; // 自定义消息前缀图标（前端扩展字段）
}
```

#### 3.2 创建会话
- **接口地址**: `POST /system/session`
- **请求类型**: `CreateSessionDTO`
- **描述**: 创建新会话

```typescript
interface CreateSessionDTO {
  createBy?: number; // 创建者
  createDept?: number; // 创建部门
  createTime?: Date; // 创建时间
  id?: string; // 主键
  params?: object; // 请求参数
  remark?: string; // 备注
  sessionContent?: string; // 会话内容
  sessionTitle: string; // 会话标题（必填）
  updateBy?: number; // 更新者
  updateTime?: Date; // 更新时间
  userId: number; // 用户id（必填）
}
```

#### 3.3 更新会话
- **接口地址**: `PUT /system/session`
- **请求类型**: `ChatSessionVo`
- **描述**: 更新会话信息

#### 3.4 获取单个会话
- **接口地址**: `GET /system/session/{id}`
- **响应类型**: `ChatSessionVo`
- **描述**: 根据ID获取单个会话详情

#### 3.5 删除会话
- **接口地址**: `DELETE /system/session/{ids}`
- **描述**: 批量删除会话（支持多个ID）

### 4. 模型模块 (Model API)

#### 4.1 获取模型列表
- **接口地址**: `GET /system/model/modelList`
- **响应类型**: `GetSessionListVO[]`
- **描述**: 获取当前用户可用的模型列表

```typescript
interface GetSessionListVO {
  id?: number; // 模型ID
  category?: string; // 模型分类
  modelName?: string; // 模型名称
  modelDescribe?: string; // 模型描述
  modelPrice?: number; // 模型价格
  modelType?: string; // 模型类型
  modelShow?: string; // 模型展示名
  systemPrompt?: string; // 系统提示词
  apiHost?: string; // API主机地址
  apiKey?: string; // API密钥
  remark?: string; // 备注
}
```

## 状态管理

### 用户状态 (useUserStore)
- **token**: 用户认证令牌
- **userInfo**: 用户信息对象
- **openLoginDialog()**: 打开登录对话框
- **logout()**: 用户登出

### 会话状态 (useSessionStore)
- **currentSession**: 当前选中的会话
- **sessionList**: 会话列表数据
- **currentPage**: 当前页码
- **pageSize**: 每页显示数量
- **hasMore**: 是否还有更多数据
- **isLoading**: 全局加载状态
- **isLoadingMore**: 加载更多状态
- **requestSessionList()**: 获取会话列表
- **createSessionBtn()**: 创建新会话
- **updateSession()**: 更新会话
- **deleteSessions()**: 删除会话

### 对话状态 (useChatStore)
- **isDeepThinking**: 是否开启深度思考
- **chatMap**: 会话ID对应的聊天记录映射
- **requestChatList()**: 获取指定会话的聊天记录
- **setDeepThinking()**: 设置深度思考状态

### 模型状态 (useModelStore)
- **currentModelInfo**: 当前选中的模型信息
- **modelList**: 可用模型列表
- **requestModelList()**: 获取模型列表
- **setCurrentModelInfo()**: 设置当前模型

## 使用示例

### 1. 用户登录
```typescript
import { login } from '@/api/auth';

async function handleLogin() {
  try {
    const result = await login({
      username: 'user@example.com',
      password: 'password123'
    });
    // 保存token和用户信息
    userStore.setToken(result.access_token);
    userStore.setUserInfo(result.userInfo);
  }
  catch (error) {
    console.error('登录失败:', error);
  }
}
```

### 2. 发送AI消息
```typescript
import { send } from '@/api/chat';

async function sendMessage(message: string, sessionId: string) {
  const sendData: SendDTO = {
    messages: [{ role: 'user', content: message }],
    sessionId,
    model: modelStore.currentModelInfo.modelName,
    userId: userStore.userInfo?.userId,
    stream: true, // 启用流式响应
  };

  try {
    const response = await send(sendData);
    // 处理流式响应
    for await (const chunk of response) {
      console.log('收到数据:', chunk);
    }
  }
  catch (error) {
    console.error('发送消息失败:', error);
  }
}
```

### 3. 获取会话列表
```typescript
import { useSessionStore } from '@/stores/modules/session';

const sessionStore = useSessionStore();

async function loadSessions() {
  await sessionStore.requestSessionList(1, true);
}
```

### 4. 获取聊天记录
```typescript
import { useChatStore } from '@/stores/modules/chat';

const chatStore = useChatStore();

async function loadChatHistory(sessionId: string) {
  await chatStore.requestChatList(sessionId);
  const messages = chatStore.chatMap[sessionId];
}
```

## 错误码说明

| 错误码 | 描述 |
|--------|------|
| 200    | 成功 |
| 401    | 未授权，需要重新登录 |
| 403    | 无权限访问 |
| 500    | 服务器内部错误 |

## 注意事项

1. **认证要求**: 除登录和注册接口外，所有接口都需要JWT认证
2. **分页参数**: 列表接口支持分页，默认pageNum=1，pageSize=25
3. **排序参数**: 支持自定义排序，通过orderByColumn和isAsc参数控制
4. **流式响应**: AI对话接口支持Server-Sent Events (SSE) 流式响应
5. **错误处理**: 所有API调用都经过统一的错误处理，包括网络错误、认证失败等
